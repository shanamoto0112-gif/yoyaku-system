<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>予約管理表</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<style>
    body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 20px;
        padding-top: 75px;
        background-color: #f4f7f6;
    }
    .date-navigator {
        position: fixed; top: 0; left: 0; width: 100%;
        background-color: #f4f7f6;
        z-index: 100; padding: 10px 20px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-sizing: border-box;
    }
    .nav-group {
        display: flex;
        align-items: center;
        gap: 15px;
    }
    .nav-group.left {
        justify-content: flex-start;
    }
    .nav-group.center {
        justify-content: center;
    }
    .nav-group.right {
        justify-content: flex-end;
    }
    .nav-group.left, .nav-group.right {
        flex: 1;
    }
    .date-navigator h2 { min-width: 200px; text-align: center; cursor: pointer; margin: 0; }
    .date-navigator button { padding: 8px 15px; border: 1px solid #ccc; background-color: #fff; border-radius: 4px; cursor: pointer; }
    .date-navigator button:hover { background-color: #e9e9e9; }
    
    /* ↓ 新しい代車予約ボタンのデザイン */
    #daisha-yoyaku-button {
        display: inline-block;
        padding: 8px 15px;
        border: 1px solid #1e7e34;
        border-radius: 4px;
        cursor: pointer;
        text-decoration: none; /* リンクの下線を消す */
        background-color: #28a745; /* 背景を緑に (データ保存ボタンと同じ色) */
        color: #fff; /* 文字を白に */
        font-weight: bold;
    }
    #daisha-yoyaku-button:hover {
        background-color: #218838; /* マウスを乗せると少し濃い緑に */
    }
    
    .date-navigator input[type="search"] {
        padding: 6px 10px;
        border-radius: 4px;
        border: 1px solid #ccc;
        font-size: 0.9em;
    }
    .data-controls {
        position: fixed; top: 10px; right: 20px; z-index: 101;
        display: flex; gap: 10px; align-items: center;
    }
    .data-controls button {
        padding: 5px 10px; font-size: 0.85em; border: 1px solid #ccc;
        background-color: #fff; border-radius: 4px; cursor: pointer;
    }
    .data-controls button:hover { background-color: #e9e9e9; }
    .today-button { background-color: #6c757d !important; color: white !important; }
    .today-button:hover { background-color: #5a6268 !important; }
    .backup-button { background-color: #28a745 !important; color: white !important; }
    .restore-button { background-color: #17a2b8 !important; color: white !important; }
    .clear-button { background-color: #dc3545 !important; color: white !important; }
    .hidden { display: none !important; }
    .scheduler-container {
        position: relative;
        height: calc(100vh - 120px); /* 100%画面高 - 上75px - 下45px */
        margin-bottom: 0;
        display: flex; flex-direction: column;
        border: 1px solid #ccc; background-color: #fff;
        width: fit-content; overflow-x: auto;
    }
    .scheduler-body {
        display: flex;
        flex-direction: column;
        flex-grow: 1; /* 残りの高さをすべて埋める */
        min-height: 0; /* flexアイテムの縮小時の崩れを防ぐ */
        overflow-y: auto; /* 中身だけをY軸(縦)スクロールさせる */
        background-color: #e9ecef;
    }
    #current-time-line {
        position: absolute;
        top: 0;
        width: 2px;
        background-color: #dc3545;
        z-index: 35;
        pointer-events: none;
        display: none;
    }
    .time-header { display: flex; border-bottom: 1px solid #ccc; background-color: #e9ecef; position: sticky; left: 0; z-index: 10; }
    .header-spacer { min-width: 40px; box-sizing: border-box; border-right: 1px solid #ccc; }
    .header-spacer { min-width: 40px; box-sizing: border-box; border-right: 1px solid #ccc; }
    .half-hour-label { min-width: 60px; text-align: left; padding: 5px 4px; font-size: 0.8em; font-weight: bold; box-sizing: border-box; border-right: 1px solid #ddd; }
    .lane { display: flex; border-bottom: 1px solid #eee; background-color: #fff; }
    .lane:last-child { border-bottom: 1px solid #ccc; }
    .lane-label { min-width: 40px; padding: 10px; background-color: #f8f9fa; border-right: 1px solid #ccc; display: flex; align-items: center; justify-content: center; font-weight: bold; position: sticky; left: 0; z-index: 5; }
    .time-slots-wrapper { position: relative; display: flex; }
    .time-slot { min-width: 30px; height: 40px; box-sizing: border-box; }
    .solid-line { border-left: 2px solid #333; }
    .dashed-line { border-left: 1px dashed #aaa; }
    .dotted-line { border-left: 1px dotted #bbb; }
    .booking-block { cursor: grab; position: absolute; height: 100%; top: 0; border: 3px solid transparent; border-radius: 4px; box-sizing: border-box; z-index: 20; transition: opacity 0.3s ease; }
    .booking-block.filtered-out { opacity: 0.2; }
    .booking-block-content { display: flex; flex-direction: column; height: 100%; justify-content: center; padding-left: 5px; overflow: hidden; }
    .booking-block-line1 { font-weight: bold; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .booking-block-line2 { font-size: 0.9em; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .booking-block.selected { border-color: #0056b3; box-shadow: 0 0 10px rgba(0, 86, 179, 0.5); }
    .booking-block.dragging { opacity: 0.5; cursor: grabbing; }
    .booking-block.resizing { cursor: default; }
    .booking-block.starts-before { border-top-left-radius: 0; border-bottom-left-radius: 0; border-left: 2px dotted #555; }
    .booking-block.ends-after { border-top-right-radius: 0; border-bottom-right-radius: 0; border-right: 2px dotted #555; }
    .booking-block.lane-color-1 { background-color: #ffdddd; border-color: #ffaaaa; color: #553333; }
    .booking-block.lane-color-2 { background-color: #ddf0ff; border-color: #aaccee; color: #334455; }
    .booking-block.lane-color-3 { background-color: #ffffdd; border-color: #f0f0aa; color: #555533; }
    .booking-block.lane-color-4 { background-color: #ddffdd; border-color: #aaffaa; color: #335533; }
    .booking-block.lane-color-5 { background-color: #eeddff; border-color: #ddaaee; color: #443355; }
    .booking-block.lane-color-6 { background-color: #ffeedd; border-color: #ffccaa; color: #665544; }
    .resize-handle { position: absolute; right: 0; top: 0; width: 8px; height: 100%; cursor: ew-resize; z-index: 30; }
    .resize-handle-left { position: absolute; left: 0; top: 0; width: 8px; height: 100%; cursor: ew-resize; z-index: 30; }
    .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); display: flex; justify-content: center; align-items: center; }
    .modal-content { background-color: #fff; padding: 20px 30px; border: 1px solid #888; width: 600px; max-width: 90%; min-height: 400px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.2); position: relative; }
    .modal-close-button { color: #aaa; position: absolute; top: 10px; right: 20px; font-size: 28px; font-weight: bold; cursor: pointer; }
    #booking-form { display: flex; flex-direction: column; gap: 0; }
    .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
    .form-grid-3col { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; }
    #start-date-input, #end-date-input { background-color: #fff; cursor: pointer; padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 1em; }
    #booking-form label { font-weight: bold; }
    #booking-form input[type="text"], #booking-form select { padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 1em; }
    .radio-group { display: flex; align-items: center; gap: 10px; }
    .radio-group label { font-weight: normal; }
    .form-buttons { display: flex; justify-content: flex-end; gap: 10px; margin-top: 10px; }
    #info-box-wrapper { position: fixed; bottom: 0; left: 0; width: 100%; background-color: #f8f9fa; border-top: 2px solid #ccc; box-shadow: 0 -2px 5px rgba(0,0,0,0.1); z-index: 50; }
    /* ▼▼▼ 新しいコードに書き換え▼ */
.footer-content {
    display: flex;
    gap: 20px;
    padding: 15px 20px;
    box-sizing: border-box;
    flex-grow: 1; /* 残りの高さいっぱいに広がる */
    min-height: 0; /* flexの縮小時の崩れを防ぐ */
}
    #info-box { width: 400px; flex-shrink: 0; border: 1px solid #ddd; border-radius: 8px; padding: 15px; overflow-y: auto; }
    #info-box-placeholder p { color: #6c757d; margin: 0; }
    #info-box-details h2 { margin-top: 0; margin-bottom: 10px; border-bottom: 1px solid #eee; padding-bottom: 10px; font-size: 1.2em; }
    #info-box-details p { margin: 8px 0; }
    #info-box-close-button { float: right; font-size: 24px; font-weight: bold; color: #aaa; cursor: pointer; line-height: 1; }
    #info-box-close-button:hover { color: #333; }
    .info-box-actions { margin-top: 15px; padding-top: 15px; border-top: 1px solid #eee; text-align: left; }
    .danger-button { background-color: #dc3545; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; }
    .danger-button:hover { background-color: #c82333; }
    .primary-button { background-color: #007bff; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; margin-left: 10px; }
    .primary-button:hover { background-color: #0069d9; }
    #info-box-wrapper {
    transition: transform 0.4s ease-in-out, height 0.4s ease-in-out;
    height: 50vh; /* 開いた時の高さを画面の50%に */
    display: flex;
    flex-direction: column;
}
    /* ▼▼▼ 1行追加▼ */
#info-box-wrapper.is-collapsed {
    transform: translateY(calc(100% - 45px));
    height: 45px; /* 閉じた時の高さをヘッダー分に固定 */
}
    #info-box-header {
        background-color: #e9ecef;
        padding: 0 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        cursor: pointer;
        border-bottom: 1px solid #ccc;
        height: 45px;
    }
    #info-box-title {
        margin: 0;
        font-size: 1.1em;
        font-weight: bold;
    }
    #info-box-toggle-button {
        background: #fff;
        border: 1px solid #ccc;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        font-size: 18px;
        line-height: 28px;
        cursor: pointer;
        font-weight: bold;
        transition: transform 0.3s;
        padding: 0;
    }
    #info-box-wrapper:not(.is-collapsed) #info-box-toggle-button {
        transform: rotate(180deg);
    }
    #daily-booking-list { flex-grow: 1; display: flex; flex-direction: column; min-width: 0; }
    #daily-booking-list h2 { margin: 0 0 10px 0; font-size: 1.2em; }
    .list-table-wrapper { flex-grow: 1; overflow-y: auto; border: 1px solid #ddd; border-radius: 4px; background-color: #fff; }
    #daily-booking-list table { width: 100%; border-collapse: collapse; font-size: 0.9em; }
    #daily-booking-list th, #daily-booking-list td { border-bottom: 1px solid #ddd; padding: 8px; text-align: left; white-space: nowrap; }
    #daily-booking-list thead th { background-color: #e9ecef; position: sticky; top: 0; }
    #daily-list-body .no-booking-row td { text-align: center; color: #888; padding: 20px; }
    #calendar-container {
        padding: 20px;
        max-width: 1200px;
        margin: 0 auto;
        background-color: #fff;
        border: 1px solid #ccc;
        border-radius: 8px;
        margin-bottom: 20px;
    }
    .calendar-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }
    .calendar-header h2 {
        margin: 0;
    }
    .calendar-header button {
        padding: 5px 10px;
        border: 1px solid #ccc;
        background-color: #fff;
        border-radius: 4px;
        cursor: pointer;
    }
    .calendar-table {
        width: 100%;
        border-collapse: collapse;
        table-layout: fixed;
    }
    .calendar-table th, .calendar-table td {
        border: 1px solid #e0e0e0;
        padding: 8px;
        vertical-align: top;
        height: 120px;
    }
    .calendar-table th {
        background-color: #f8f9fa;
        height: auto;
        text-align: center;
    }
    .calendar-day {
        font-weight: bold;
    }
    .day-saturday { color: #0056b3; }
    .day-sunday { color: #dc3545; }
    .other-month .calendar-day {
        color: #ccc;
    }
    .booking-count {
        margin-top: 8px;
        font-size: 0.9em;
        background-color: #e0f2e9;
        padding: 3px 5px;
        border-radius: 4px;
        display: inline-block;
    }
    .calendar-table td:hover {
        background-color: #f4f7f6;
        cursor: pointer;
    }
    #info-box-details h2 .primary-button {
        float: right;
        margin-right: 15px;
        margin-left: 0;
        padding: 2px 10px;
        font-size: 0.85em;
        vertical-align: middle;
    }

    /* ========================================================================= */
    /* スマートフォン向けスタイル (768px以下で適用) */
    /* ========================================================================= */
    @media (max-width: 768px) {
        body {
            padding: 10px;
            padding-top: 120px; /* ヘッダーの高さ分を確保 */
        }
        .date-navigator {
            flex-direction: column; /* 縦並びにする */
            padding: 10px;
        }
        .nav-group {
            width: 100%;
            justify-content: space-between !important; /* 中央揃えを解除 */
            margin-bottom: 5px;
        }
        .date-navigator h2 {
            font-size: 1.2em;
        }
        .scheduler-container {
            margin-bottom: 45px !important; /* 下の閉じた情報欄の高さ分を確保 */
        }
        .footer-content {
            flex-direction: column; /* 縦並びにする */
            max-height: 50vh; /* 画面の半分の高さに制限 */
        }
        #info-box {
            width: 100%;
            box-sizing: border-box;
            margin-bottom: 10px;
        }
        .modal-content {
            width: 95%;
            padding: 15px;
        }
        .form-grid, .form-grid-3col {
            grid-template-columns: 1fr; /* 1列にする */
        }
        
        /* 横向きのスマホ用スタイル (高さが幅より小さい場合) */
        @media (orientation: landscape) {
            .footer-content {
                flex-direction: row !important; /* 横並びに戻す */
            }
            #info-box {
                width: 400px !important; /* PCと同じ幅に戻す */
            }
        }
    }
    #booking-form .form-grid, #booking-form .form-grid-3col {
        gap: 15px; /* 基本の間隔を15pxに戻します */
    }
    #booking-form > div { /* フォーム直下のdivの間隔 */
        margin-bottom: 10px;
    }
    #booking-form label {
        display: block; /* ラベルをブロック要素にして改行させます */
        margin-bottom: 5px;
    }
    #booking-form input[type="text"], #booking-form select {
        width: 100%; /* 入力欄の幅を親要素に合わせます */
        box-sizing: border-box; /* paddingを含めて幅100%になるようにします */
    }
    .user-car-grid {
        display: grid;
        grid-template-columns: auto 1fr auto auto; /* ラベル, ユーザー名入力, ラベル, 車番入力 */
        gap: 0 10px; /* 縦の隙間は0, 横の隙間は10px */
        align-items: center; /* 要素を上下中央に揃えます */
    }
    .user-car-grid label {
        display: inline; /* このグリッド内のラベルは横並びのためinlineに戻します */
        margin-bottom: 0;
    }
    .user-car-grid input {
        width: auto; /* このグリッド内の入力欄は自動幅にします */
    }
<style>
        /* Netlifyのログアウトボタン用のスタイル */
        [data-netlify-identity-menu] {
            margin-left: auto; /* 右端に配置 */
        }
        [data-netlify-identity-menu] .netlify-identity-button {
            background-color: #6c757d;
            color: white;
            border-radius: 4px;
            padding: 8px 15px;
            font-size: 1em;
            font-weight: normal;
        }
        [data-netlify-identity-menu] .netlify-identity-button:hover {
            background-color: #5a6268;
        }
</style>
<!-- Netlify Identity Widgetのスクリプトを読み込みます -->
<script type="text/javascript" src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
</head>
<body>

    <div class="date-navigator">
        <div class="nav-group left">
            <a href="daisha_yoyaku.html" id="daisha-yoyaku-button">代車予約</a>
            <button id="view-toggle-button">月表示</button>
        </div>
        <div class="nav-group center">
            <button id="prev-day-button">&lt; PREV</button>
            <h2 id="current-date-display">2025年10月01日</h2>
            <button id="next-day-button">NEXT &gt;</button>
        </div>
        <div class="nav-group right"></div>
    </div>

    <div class="data-controls">
        <button id="today-button" class="today-button">今日</button>
        <button id="backup-button" class="backup-button">データ保存</button>
        <button id="restore-button" class="restore-button">データ復元</button>
        <button id="clear-data-button" class="clear-button">データクリア</button>
        <input type="file" id="restore-file-input" class="hidden" accept=".json">
    </div>

    <div id="calendar-container" class="hidden"></div>

    <div id="main-scheduler-container" class="scheduler-container">
        <div class="time-header"></div>
        <div class="scheduler-body"></div>
        <div id="current-time-line"></div>
    </div>

    <div id="info-box-wrapper">
        <div id="info-box-header">
            <h2 id="info-box-title">本日の予約リスト / 詳細</h2>
            <button id="info-box-toggle-button">＾</button>
        </div>
        <div class="footer-content">
            <div id="info-box">
                <div id="info-box-placeholder">
                    <p>予約ブロックをクリックすると、ここに詳細が表示されます。</p>
                </div>
                <div id="info-box-details" style="display: none;">
                    <h2>予約詳細<span id="info-box-close-button">&times;</span><button id="edit-booking-button" class="primary-button">編集</button></h2>
                    <p><strong>レーン:</strong> <span id="info-lane-number"></span></p>
                    <p><strong>日時:</strong> <span id="info-datetime"></span></p>
                    <p><strong>ユーザー名:</strong> <span id="info-user-name"></span></p>
                    <p><strong>車番:</strong> <span id="info-car-number"></span></p>
                    <p><strong>種別:</strong> <span id="info-booking-type"></span></p>
                    <p><strong>担当者:</strong> <span id="info-staff-name"></span></p>
                    <p><strong>代車:</strong> <span id="info-loaner"></span></p>
                    <p><strong>引取:</strong> <span id="info-pickup"></span></p>
                    <p><strong>納車:</strong> <span id="info-delivery"></span></p>
                    <div class="info-box-actions">
                        <button id="delete-booking-button" class="danger-button">この予約を削除</button>
                    </div>
                </div>
            </div>
            <div id="daily-booking-list">
                <h2>本日の予約リスト</h2>
                <div class="list-table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>レーン</th>
                                <th>ユーザー名</th>
                                <th>車番</th>
                                <th>種別</th>
                                <th>担当者</th>
                                <th>予約時間</th>
                            </tr>
                        </thead>
                        <tbody id="daily-list-body"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div id="booking-modal" class="modal">
        <div class="modal-content">
            <span class="modal-close-button">&times;</span>
            <h2>予約情報入力</h2>
            <form id="booking-form">
                <div class="form-grid">
                    <div>
                        <label for="staff-select">担当者1:</label>
                        <select id="staff-select">
                            <option value="小林">小林</option>
                            <option value="久保川">久保川</option>
                            <option value="松居">松居</option>
                            <option value="井野">井野</option>
                            <option value="オマーク">オマーク</option>
                            <option value="マイロン">マイロン</option>
                            <option value="Marki">Marki</option>
                        </select>
                    </div>
                    <div>
                        <label for="staff-select-2">担当者2 (任意):</label>
                        <select id="staff-select-2">
                            <option value="">--</option>
                            <option value="小林">小林</option>
                            <option value="久保川">久保川</option>
                            <option value="松居">松居</option>
                            <option value="井野">井野</option>
                            <option value="オマーク">オマーク</option>
                            <option value="マイロン">マイロン</option>
                            <option value="Marki">Marki</option>
                        </select>
                    </div>
                    <div>
                        <label for="lane-select">レーン:</label>
                        <select id="lane-select"><option value="1">①</option><option value="2">②</option><option value="3">③</option><option value="4">④</option><option value="5">⑤</option><option value="6">検査</option></select>
                    </div>
                    <div>
                        <label for="booking-type">種別:</label>
                        <select id="booking-type"><option value="車検">車検</option><option value="点検">点検</option><option value="一般">一般</option><option value="Sメンテ">Sメンテ</option><option value="Mメンテ">Mメンテ</option><option value="Lメンテ">Lメンテ</option></select>
                    </div>
                </div>
                <div class="form-grid">
                    <div><label for="start-date-input">開始日時:</label><input type="text" id="start-date-input" placeholder="日付を選択..."></div>
                    <div><label for="end-date-input">終了日時:</label><input type="text" id="end-date-input" placeholder="日付を選択..."></div>
                </div>
                <div class="user-car-grid">
                    <label for="user-name">ユーザー名:</label>
                    <input type="text" id="user-name" list="user-name-list" required>
                    <label for="car-number">車番:</label>
                    <input type="text" id="car-number" inputmode="numeric" maxlength="4">
                </div>
                <datalist id="user-name-list"></datalist>
                <div class="radio-group"><label>代車:</label><input type="radio" id="loaner-needed" name="loaner" value="必要" checked><label for="loaner-needed">必要</label><input type="radio" id="loaner-not-needed" name="loaner" value="不必要"><label for="loaner-not-needed">不必要</label></div>
                <div class="radio-group"><label>引取:</label><input type="radio" id="pickup-needed" name="pickup" value="必要"><label for="pickup-needed">必要</label><input type="radio" id="pickup-not-needed" name="pickup" value="不必要" checked><label for="pickup-not-needed">不必要</label></div>
                <div class="radio-group"><label>納車:</label><input type="radio" id="delivery-needed" name="delivery" value="必要"><label for="delivery-needed">必要</label><input type="radio" id="delivery-not-needed" name="delivery" value="不必要" checked><label for="delivery-not-needed">不必要</label></div>
                <div class="form-buttons"><button type="submit">保存</button><button type="button" id="cancel-button">キャンセル</button></div>
            </form>
        </div>
    </div>

    <!-- ↓↓↓ ここから下に貼り付け ↓↓↓ -->
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ja.js"></script>

    <!-- ▼▼▼ ここからFirebase接続コードを追加 ▼▼▼ -->
    <!-- Firebase App (コア) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <!-- Firebase Firestore (データベース) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <script>
    // TODO: Replace the following with your app's Firebase project configuration
            // 【重要】Firebaseの接続情報（firebaseConfig）は、
        // あなたがFirebaseの画面からコピーしたものに差し替えるのを忘れないでください。
        const firebaseConfig = {
            apiKey: "AIzaSyDsgnJTAbc7FShXFXWBsR25IDXQox8sQjM",
            authDomain: "maruni-yoyaku-system.firebaseapp.com",
            projectId: "maruni-yoyaku-system",
            storageBucket: "maruni-yoyaku-system.firebasestorage.app",
            messagingSenderId: "419757490787",
            appId: "1:419757490787:web:095eb61e85d008ea2b2e56"
        };
        // Firebaseを初期化する
        firebase.initializeApp(firebaseConfig);
        // Firestoreデータベースへの参照を準備する
        const db = firebase.firestore();

        document.addEventListener('DOMContentLoaded', () => {
    // =========================================================================
    // Netlify Identityによるログイン状態と権限の確認 ★一時的に無効化！
    // =========================================================================
    // const user = netlifyIdentity.currentUser();
    // if (!user) {
    //     window.location.href = '/index.html';
    //     return;
    // }
    // const userRoles = user.app_metadata.roles || [];
    
    // ★全員が編集できるように、一時的に isEditor を true に固定します
    const isEditor = true;

    // if (!isEditor) {
    //     const idsToHide = ['edit-booking-button', 'delete-booking-button', 'backup-button', 'restore-button', 'clear-data-button'];
    //     idsToHide.forEach(id => {
    //         const element = document.getElementById(id);
    //         if (element) {
    //             element.style.display = 'none';
    //         }
    //     });
    //     const saveButtonInModal = document.querySelector('#booking-form button[type="submit"]');
    //     if (saveButtonInModal) {
    //         saveButtonInModal.style.display = 'none';
    //     }
    // }

            // =========================================================================
            // 1. 変数と定数の定義
            // =========================================================================
            const totalLanes = 6;
            const slotWidth = 30;
            const startHour = 8;
            const startMinute = 30;
            const endHour = 19;
            let currentDate = new Date();
            let allBookings = [];
            let currentClickedSlotInfo = null;
            let startPicker, endPicker;
            let editingBookingId = null;
            let currentView = 'daily';

            // =========================================================================
            // 2. Firebase(Firestore)機能 ★localStorageからFirebaseに変更！
            // =========================================================================
            
            //【リアルタイムリスナー】Firestoreからデータを読み込み、変更を監視する
            function setupRealtimeListener() {
                db.collection('yoyaku_bookings').onSnapshot(snapshot => {
                    const bookingsFromFirestore = [];
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        bookingsFromFirestore.push({
                            ...data,
                            id: doc.id,
                            startDate: data.startDate.toDate(),
                            endDate: data.endDate.toDate()
                        });
                    });
                    allBookings = bookingsFromFirestore;
                    console.log('Firestoreからデータを取得しました:', allBookings.length, '件');
                    renderForDate(currentDate);
                    updateSuggestionLists();
                }, error => {
                    console.error("データの取得に失敗しました: ", error);
                    alert("データベースからのデータ取得に失敗しました。ページを再読み込みしてください。");
                });
            }

            //【保存＆更新】予約データをFirestoreに保存または更新する
            async function saveBooking(bookingData) {
                try {
                    const dataToSave = { ...bookingData,
                        startDate: firebase.firestore.Timestamp.fromDate(bookingData.startDate),
                        endDate: firebase.firestore.Timestamp.fromDate(bookingData.endDate)
                    };
                    const docRef = dataToSave.id ? db.collection('yoyaku_bookings').doc(dataToSave.id) : db.collection('yoyaku_bookings').doc();
                    if (dataToSave.id) delete dataToSave.id;
                    await docRef.set(dataToSave, { merge: true });
                    console.log('予約を保存しました:', docRef.id);
                    return true;
                } catch (error) {
                    console.error('予約の保存に失敗しました:', error);
                    alert('予約の保存に失敗しました。');
                    return false;
                }
            }

            //【削除】予約データをFirestoreから削除する
            async function deleteBooking(bookingId) {
                try {
                    await db.collection('yoyaku_bookings').doc(bookingId).delete();
                    console.log('予約を削除しました:', bookingId);
                    return true;
                } catch (error) {
                    console.error('予約の削除に失敗しました:', error);
                    alert('予約の削除に失敗しました。');
                    return false;
                }
            }

            // データのエクスポート機能（変更なし）
            function exportData() {
                try {
                    const dataToExport = {
                        exportDate: new Date().toISOString(),
                        bookings: allBookings.map(booking => ({
                            ...booking,
                            startDate: booking.startDate.toISOString(),
                            endDate: booking.endDate.toISOString()
                        }))
                    };
                    const blob = new Blob([JSON.stringify(dataToExport, null, 2)], {type: 'application/json'});
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `予約データ_${formatDate(new Date(), 'YYYY-MM-DD')}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    alert('データを保存しました');
                } catch (error) {
                    console.error('データのエクスポートに失敗しました:', error);
                    alert('データの保存に失敗しました');
                }
            }
            
            // データのインポート機能（手動でのデータ移行用）
            function importData(fileContent) {
                if (!confirm("ファイルからデータをインポートしますか？\n現在の全ての予約がファイルの内容に置き換えられます。")) return;
                try {
                    const importedData = JSON.parse(fileContent);
                    if (importedData.bookings && Array.isArray(importedData.bookings)) {
                        const importPromises = importedData.bookings.map(b => {
                            const bookingData = { ...b };
                            // ローカルファイルからなのでIDは削除
                            delete bookingData.id; 
                            bookingData.startDate = new Date(b.startDate);
                            bookingData.endDate = new Date(b.endDate);
                            return saveBooking(bookingData);
                        });
                        Promise.all(importPromises)
                            .then(() => alert(`データをインポートしました (${importedData.bookings.length}件)`))
                            .catch(() => alert('データのインポート中にエラーが発生しました。'));
                    } else {
                        alert('無効なデータファイルです');
                    }
                } catch (error) {
                    console.error('データのインポートに失敗しました:', error);
                    alert('データの復元に失敗しました');
                }
            }
            
            // ★Firestore用に書き換え
            function clearAllData() {
                if (confirm('全ての予約データを削除しますか？\nこの操作は取り消せません。')) {
                    const deletePromises = allBookings.map(booking => deleteBooking(booking.id));
                    Promise.all(deletePromises)
                        .then(() => alert('全てのデータを削除しました'))
                        .catch(error => {
                            console.error("一括削除中にエラーが発生しました:", error);
                            alert("データの削除中にエラーが発生しました。");
                        });
                }
            }

            // =========================================================================
            // 3. HTML要素の取得
            // =========================================================================
            const modal = document.getElementById('booking-modal');
            const bookingForm = document.getElementById('booking-form');
            const closeButton = document.querySelector('.modal-close-button');
            const cancelButton = document.getElementById('cancel-button');
            const infoBoxPlaceholder = document.getElementById('info-box-placeholder');
            const infoBoxDetails = document.getElementById('info-box-details');
            const infoBoxCloseButton = document.getElementById('info-box-close-button');
            const prevDayButton = document.getElementById('prev-day-button');
            const nextDayButton = document.getElementById('next-day-button');
            const currentDateDisplay = document.getElementById('current-date-display');
            const deleteBookingButton = document.getElementById('delete-booking-button');
            const editBookingButton = document.getElementById('edit-booking-button');
            const dailyListBody = document.getElementById('daily-list-body');
            const todayButton = document.getElementById('today-button');
            const backupButton = document.getElementById('backup-button');
            const restoreButton = document.getElementById('restore-button');
            const clearDataButton = document.getElementById('clear-data-button');
            const restoreFileInput = document.getElementById('restore-file-input');
            const viewToggleButton = document.getElementById('view-toggle-button');
            const calendarContainer = document.getElementById('calendar-container');
            const schedulerContainer = document.getElementById('main-scheduler-container');
            const currentTimeLine = document.getElementById('current-time-line');
            
            // =========================================================================
            // 4. ヘルパー関数の定義（ここは変更なし）
            // =========================================================================
            function formatDate(date, format) { /* ...変更なし... */ }
            function updateCurrentTimeLine() { /* ...変更なし... */ }
            function updateDateDisplay(date) { /* ...変更なし... */ }
            function openModal(slotInfo, bookingToEdit = null) { /* ...変更なし... */ }
            function closeModal() { /* ...変更なし... */ }
            function closeInfoBox() { /* ...変更なし... */ }
            function clearSelection() { /* ...変更なし... */ }
            function updateInfoBox(blockElement) { /* ...変更なし... */ }
            function updateSuggestionLists() { /* ...変更なし... */ }
            function addBookingToList(booking) { /* ...変更なし... */ }
            function createBookingBlock(booking) { /* ...変更なし... */ }
            function renderMonthCalendar(date) { /* ...変更なし... */ }
            function toggleView(targetView) { /* ...変更なし... */ }
            function renderDailySchedule() { /* ...変更なし... */ }

            // ... formatDateからrenderDailyScheduleまでの関数の内容は元のファイルと同じなので省略しています ...
            // （実際には、これらの関数のコードは全て貼り付けてください）
            
            // =========================================================================
            // ここから下に関数の中身を記述します（元のコードと同じです）
            // =========================================================================
            function formatDate(date, format) {
                const d = new Date(date);
                const y = d.getFullYear();
                const m = String(d.getMonth() + 1).padStart(2, '0');
                const day = String(d.getDate()).padStart(2, '0');
                const h = String(d.getHours()).padStart(2, '0');
                const min = String(d.getMinutes()).padStart(2, '0');
                return format.replace('YYYY', y).replace('MM', m).replace('DD', day).replace('HH', h).replace('mm', min);
            }

            function updateCurrentTimeLine() {
                const mainScheduler = document.getElementById('main-scheduler-container');
                const firstTimeSlotWrapper = mainScheduler.querySelector('.time-slots-wrapper');
                if (!mainScheduler || !firstTimeSlotWrapper) return;
                const now = new Date();
                const todayString = formatDate(now, 'YYYY-MM-DD');
                const displayedDateString = formatDate(currentDate, 'YYYY-MM-DD');
                if (todayString !== displayedDateString) {
                    currentTimeLine.style.display = 'none';
                    return;
                }
                const schedulerStartMillis = new Date(currentDate.getFullYear(), currentDate.getMonth(), currentDate.getDate(), startHour, startMinute, 0, 0).getTime();
                const schedulerEndMillis = new Date(currentDate.getFullYear(), currentDate.getMonth(), currentDate.getDate(), endHour, 0, 0, 0).getTime();
                const nowMillis = now.getTime();
                if (nowMillis < schedulerStartMillis || nowMillis > schedulerEndMillis) {
                    currentTimeLine.style.display = 'none';
                    return;
                }
                const containerRect = mainScheduler.getBoundingClientRect();
                const timeSlotsRect = firstTimeSlotWrapper.getBoundingClientRect();
                const timelineStartOffset = timeSlotsRect.left - containerRect.left;
                const minutesFromStart = (nowMillis - schedulerStartMillis) / 60000;
                const pixelsPerMinute = slotWidth / 15;
                const timeOffset = minutesFromStart * pixelsPerMinute;
                const finalLeftPosition = timelineStartOffset + timeOffset;
                const timeHeader = mainScheduler.querySelector('.time-header');
                const lanes = mainScheduler.querySelectorAll('.lane');
                let totalLanesHeight = 0;
                lanes.forEach(lane => { totalLanesHeight += lane.offsetHeight; });
                currentTimeLine.style.top = `${timeHeader.offsetHeight}px`;
                currentTimeLine.style.height = `${totalLanesHeight}px`;
                currentTimeLine.style.transform = `translateX(${finalLeftPosition - 1}px)`;
                currentTimeLine.style.display = 'block';
            }

            function updateDateDisplay(date) {
                if (currentView === 'daily') {
                    currentDateDisplay.textContent = formatDate(date, 'YYYY年MM月DD日');
                } else {
                    currentDateDisplay.textContent = formatDate(date, 'YYYY年MM月');
                }
            }

            function openModal(slotInfo, bookingToEdit = null) {
                let initialStartDate, initialEndDate, initialLane;
                if (bookingToEdit) {
                    editingBookingId = bookingToEdit.id;
                    initialStartDate = new Date(bookingToEdit.startDate);
                    initialEndDate = new Date(bookingToEdit.endDate);
                    document.getElementById('user-name').value = bookingToEdit.userName;
                    document.getElementById('car-number').value = bookingToEdit.carNumber;
                    document.getElementById('booking-type').value = bookingToEdit.bookingType;
                    document.getElementById('staff-select').value = bookingToEdit.staffName;
                    document.getElementById('staff-select-2').value = bookingToEdit.staffName2 || '';
                    document.querySelector(`input[name="loaner"][value="${bookingToEdit.loaner}"]`).checked = true;
                    document.querySelector(`input[name="pickup"][value="${bookingToEdit.pickup}"]`).checked = true;
                    document.querySelector(`input[name="delivery"][value="${bookingToEdit.delivery}"]`).checked = true;
                    document.getElementById('lane-select').value = bookingToEdit.lane;
                } else {
                    editingBookingId = null;
                    initialStartDate = new Date(currentDate);
                    if (slotInfo) initialStartDate.setHours(slotInfo.hour, slotInfo.minute, 0, 0);
                    initialEndDate = new Date(initialStartDate.getTime() + 60 * 60 * 1000);
                    initialLane = slotInfo.lane;
                    document.getElementById('lane-select').value = slotInfo.lane;
                }
                if (startPicker) startPicker.destroy();
                if (endPicker) endPicker.destroy();
                startPicker = flatpickr("#start-date-input", { locale: "ja", enableTime: true, time_24hr: true, minuteIncrement: 15, defaultDate: initialStartDate, onChange: function(selectedDates) { if (selectedDates[0]) endPicker.set('minDate', selectedDates[0]); } });
                endPicker = flatpickr("#end-date-input", { locale: "ja", enableTime: true, time_24hr: true, minuteIncrement: 15, defaultDate: initialEndDate, minDate: initialStartDate });
                updateSuggestionLists();
                modal.style.display = 'flex';
            }

            function closeModal() {
                if (startPicker) startPicker.destroy();
                if (endPicker) endPicker.destroy();
                startPicker = null; endPicker = null;
                editingBookingId = null;
                bookingForm.reset();
                modal.style.display = 'none';
            }
            
            function closeInfoBox() { document.getElementById('info-box-wrapper').classList.add('is-collapsed'); }
            
            function clearSelection() {
                const selectedBlock = document.querySelector('.booking-block.selected');
                if (selectedBlock) selectedBlock.classList.remove('selected');
                infoBoxPlaceholder.style.display = 'block';
                infoBoxDetails.style.display = 'none';
            }

            function updateInfoBox(blockElement) {
                if (!blockElement) return;
                clearSelection();
                blockElement.classList.add('selected');
                const data = blockElement.dataset;
                const startDate = new Date(data.startDate);
                const endDate = new Date(data.endDate);
                const startTime = formatDate(startDate, 'HH:mm');
                let endTime = formatDate(endDate, 'HH:mm');
                let displayEndDate = endDate;
                if (endTime === "00:00" && startDate.getTime() < endDate.getTime()) {
                    endTime = "24:00";
                    displayEndDate = new Date(endDate.getTime() - 60000);
                }
                document.getElementById('info-lane-number').textContent = data.lane;
                document.getElementById('info-datetime').textContent = `${formatDate(startDate, 'YYYY/MM/DD')} ${startTime} ～ ${formatDate(displayEndDate, 'YYYY/MM/DD')} ${endTime}`;
                document.getElementById('info-user-name').textContent = data.userName;
                document.getElementById('info-car-number').textContent = data.carNumber;
                document.getElementById('info-booking-type').textContent = data.bookingType;
                let staffInfo = data.staffName;
                if (data.staffName2) staffInfo += `, ${data.staffName2}`;
                document.getElementById('info-staff-name').textContent = staffInfo;
                document.getElementById('info-loaner').textContent = data.loaner;
                document.getElementById('info-pickup').textContent = data.pickup;
                document.getElementById('info-delivery').textContent = data.delivery;
                infoBoxPlaceholder.style.display = 'none';
                document.getElementById('info-box-wrapper').classList.remove('is-collapsed');
                infoBoxDetails.style.display = 'block';
            }
            
            function updateSuggestionLists() {
                const userNameDatalist = document.getElementById('user-name-list');
                const uniqueUserNames = [...new Set(allBookings.map(b => b.userName).filter(name => name))];
                userNameDatalist.innerHTML = uniqueUserNames.map(name => `<option value="${name}"></option>`).join('');
            }
            
            function addBookingToList(booking) {
                const row = document.createElement('tr');
                const startTime = formatDate(booking.startDate, 'MM/DD HH:mm');
                const endTime = formatDate(booking.endDate, 'MM/DD HH:mm');
                let staffList = booking.staffName;
                if (booking.staffName2) staffList += `, ${booking.staffName2}`;
                row.innerHTML = `<td>${booking.lane}</td><td>${booking.userName}</td><td>${booking.carNumber}</td><td>${booking.bookingType}</td><td>${staffList}</td><td>${startTime} ～ ${endTime}</td>`;
                dailyListBody.appendChild(row);
            }

            function createBookingBlock(booking) {
                const bookingBlock = document.createElement('div');
                bookingBlock.id = booking.id;
                bookingBlock.className = `booking-block lane-color-${booking.lane}`;
                bookingBlock.innerHTML = `<div class="booking-block-content"><div class="booking-block-line1">${booking.userName || ''} / ${booking.carNumber || ''}</div><div class="booking-block-line2">${booking.bookingType || ''} / ${booking.staffName || ''}${booking.staffName2 ? ` / ${booking.staffName2}` : ''}</div></div>`;
                Object.keys(booking).forEach(key => { if (typeof booking[key] !== 'object') bookingBlock.dataset[key] = booking[key]; });
                bookingBlock.dataset.startDate = booking.startDate.toISOString();
                bookingBlock.dataset.endDate = booking.endDate.toISOString();
                const dayStartMillis = new Date(currentDate).setHours(startHour, startMinute, 0, 0);
                const dayEndMillis = new Date(currentDate).setHours(endHour, 0, 0, 0);
                const startMillis = Math.max(booking.startDate.getTime(), dayStartMillis);
                const endMillis = Math.min(booking.endDate.getTime(), dayEndMillis);
                const startOffsetMinutes = (startMillis - dayStartMillis) / 60000;
                const durationMinutes = (endMillis - startMillis) / 60000;
                if (booking.startDate.getTime() < dayStartMillis) bookingBlock.classList.add('starts-before');
                if (booking.endDate.getTime() > dayEndMillis) bookingBlock.classList.add('ends-after');
                if (durationMinutes > 0) {
                    bookingBlock.style.left = `${(startOffsetMinutes / 15) * slotWidth}px`;
                    bookingBlock.style.width = `${(durationMinutes / 15) * slotWidth}px`;
                } else {
                    bookingBlock.style.display = 'none';
                }
                addInteractions(bookingBlock);
                document.getElementById(`lane-wrapper-${booking.lane}`)?.appendChild(bookingBlock);
            }
            
            function renderMonthCalendar(date) { /* ...変更なし... */ }
            function toggleView(targetView) { /* ...変更なし... */ }

            // ★Interaction系はFirestore呼び出しに変更
            function addInteractions(block) {
                addResizeListeners(block, 'right');
                addResizeListeners(block, 'left');
                block.addEventListener('click', (e) => { e.stopPropagation(); if (e.currentTarget.classList.contains('selected')) { clearSelection(); closeInfoBox(); return; } updateInfoBox(e.currentTarget); });
                block.draggable = true;
                block.addEventListener('dragstart', (e) => { if (e.target.classList.contains('resizing')) { e.preventDefault(); return; } e.dataTransfer.setData('text/plain', e.target.id); setTimeout(() => e.target.classList.add('dragging'), 0); });
                block.addEventListener('dragend', (e) => e.target.classList.remove('dragging'));
            }

            function addResizeListeners(block, direction) {
                if ((direction === 'left' && block.classList.contains('starts-before')) || (direction === 'right' && block.classList.contains('ends-after'))) return;
                const handle = document.createElement('div');
                handle.className = direction === 'right' ? 'resize-handle' : 'resize-handle-left';
                block.appendChild(handle);
                handle.addEventListener('mousedown', (e) => {
                    e.preventDefault(); e.stopPropagation();
                    const startX = e.pageX, startWidth = block.offsetWidth, startLeft = block.offsetLeft;
                    block.classList.add('resizing');
                    function handleMouseMove(moveEvent) {
                        const deltaX = moveEvent.pageX - startX;
                        if (direction === 'right') {
                            const newWidth = startWidth + deltaX;
                            if (newWidth >= slotWidth) block.style.width = `${newWidth}px`;
                        } else {
                            const newWidth = startWidth - deltaX;
                            const newLeft = startLeft + deltaX;
                            if (newWidth >= slotWidth) { block.style.width = `${newWidth}px`; block.style.left = `${newLeft}px`; }
                        }
                    }
                    function handleMouseUp() {
                        const booking = allBookings.find(b => b.id === block.id);
                        if (booking) {
                            const originalStartDate = new Date(booking.startDate);
                            const dayStartMillis = new Date(currentDate).setHours(startHour, startMinute, 0, 0);
                            if (direction === 'left') {
                                const newStartMillis = dayStartMillis + (Math.round(block.offsetLeft / slotWidth) * slotWidth / slotWidth * 15 * 60000);
                                booking.startDate = new Date(newStartMillis);
                                if (booking.startDate >= booking.endDate) booking.startDate = originalStartDate;
                            } else {
                                const newEndMillis = dayStartMillis + ((block.offsetLeft + Math.round(block.offsetWidth / slotWidth) * slotWidth) / slotWidth * 15 * 60000);
                                booking.endDate = new Date(newEndMillis);
                                if (booking.endDate <= booking.startDate) booking.endDate = new Date(originalStartDate.getTime() + (booking.endDate.getTime() - booking.startDate.getTime()));
                            }
                            saveBooking(booking).then(() => setTimeout(() => { const updatedBlock = document.getElementById(booking.id); if (updatedBlock) updateInfoBox(updatedBlock); }, 100));
                        }
                        block.classList.remove('resizing');
                        document.removeEventListener('mousemove', handleMouseMove);
                        document.removeEventListener('mouseup', handleMouseUp);
                    }
                    document.addEventListener('mousemove', handleMouseMove);
                    document.addEventListener('mouseup', handleMouseUp);
                });
            }

            function renderDailySchedule() {
                schedulerContainer.querySelector('.scheduler-body').querySelectorAll('.booking-block').forEach(block => block.remove());
                dailyListBody.innerHTML = '';
                const startOfDay = new Date(currentDate); startOfDay.setHours(0, 0, 0, 0);
                const endOfDay = new Date(currentDate); endOfDay.setHours(23, 59, 59, 999);
                let bookingsForDay = allBookings.filter(b => b.startDate < endOfDay && b.endDate > startOfDay);
                bookingsForDay.sort((a, b) => (a.lane - b.lane) || (a.startDate - b.startDate));
                if (bookingsForDay.length === 0) {
                    dailyListBody.innerHTML = '<tr class="no-booking-row"><td colspan="6">本日の予約はありません。</td></tr>';
                } else {
                    bookingsForDay.forEach(booking => { createBookingBlock(booking); addBookingToList(booking); });
                }
                clearSelection();
                updateCurrentTimeLine();
            }

            function buildSchedulerUI() {
                const mainSchedulerHeader = schedulerContainer.querySelector('.time-header');
                const mainSchedulerBody = schedulerContainer.querySelector('.scheduler-body');
                mainSchedulerHeader.innerHTML = '<div class="header-spacer"></div>';
                mainSchedulerBody.innerHTML = '';
                const totalMinutes = (endHour - startHour) * 60 - startMinute;
                for (let i = 0; i <= Math.ceil(totalMinutes / 30); i++) {
                    const currentMinute = startMinute + i * 30;
                    const hour = startHour + Math.floor(currentMinute / 60);
                    const minute = currentMinute % 60;
                    mainSchedulerHeader.innerHTML += `<div class="half-hour-label">${String(hour).padStart(2, '0')}:${String(minute).padStart(2, '0')}</div>`;
                }
                for (let i = 1; i <= totalLanes; i++) {
                    const lane = document.createElement('div');
                    lane.className = 'lane';
                    lane.id = `lane-${i}`;
                    lane.innerHTML = `<div class="lane-label">${['①', '②', '③', '④', '⑤', '検査'][i - 1]}</div><div class="time-slots-wrapper" id="lane-wrapper-${i}"></div>`;
                    const wrapper = lane.querySelector('.time-slots-wrapper');
                    wrapper.addEventListener('dragover', (e) => e.preventDefault());
                    wrapper.addEventListener('drop', (e) => { // ★Firestore呼び出しに変更
                        e.preventDefault();
                        const id = e.dataTransfer.getData('text/plain');
                        const booking = allBookings.find(b => b.id === id);
                        if (booking) {
                            const rect = wrapper.getBoundingClientRect();
                            const x = e.clientX - rect.left + wrapper.scrollLeft;
                            const slotIndex = Math.round(x / slotWidth);
                            const durationMillis = booking.endDate.getTime() - booking.startDate.getTime();
                            const dayStartMillis = new Date(currentDate).setHours(startHour, startMinute, 0, 0);
                            const newStartMillis = dayStartMillis + (slotIndex * 15 * 60000);
                            const newStartDate = new Date(newStartMillis);
                            const newEndDate = new Date(newStartMillis + durationMillis);
                            const targetLane = i;
                            const isOverlapping = allBookings.some(b => b.id !== id && b.lane === targetLane && newStartDate < b.endDate && newEndDate > b.startDate);
                            if (isOverlapping) {
                                alert("他の予約と重複するため、移動できません。");
                                renderDailySchedule();
                            } else {
                                booking.startDate = newStartDate;
                                booking.endDate = newEndDate;
                                booking.lane = targetLane;
                                saveBooking(booking).then(() => setTimeout(() => { const movedBlock = document.getElementById(id); if (movedBlock) updateInfoBox(movedBlock); }, 100));
                            }
                        }
                    });
                    for (let j = 0; j < totalMinutes / 15; j++) {
                        const currentMinute = startMinute + j * 15;
                        const hour = startHour + Math.floor(currentMinute / 60);
                        const minute = currentMinute % 60;
                        const slot = document.createElement('div');
                        slot.className = 'time-slot';
                        slot.addEventListener('click', () => { if (isEditor) openModal({ lane: i, hour, minute }); });
                        if (minute === 0) slot.classList.add('solid-line');
                        else if (minute === 30) slot.classList.add('dashed-line');
                        else slot.classList.add('dotted-line');
                        wrapper.appendChild(slot);
                    }
                    mainSchedulerBody.appendChild(lane);
                }
            }

            function renderForDate(date) {
                currentDate = date;
                updateDateDisplay(date);
                if (currentView === 'daily') {
                    renderDailySchedule();
                } else if (currentView === 'monthly') {
                    renderMonthCalendar(date);
                }
            }
            
            // =========================================================================
            // 5. イベントリスナーの登録
            // =========================================================================
            todayButton.addEventListener('click', () => renderForDate(new Date()));
            prevDayButton.addEventListener('click', () => { currentDate.setDate(currentDate.getDate() - 1); renderForDate(currentDate); });
            nextDayButton.addEventListener('click', () => { currentDate.setDate(currentDate.getDate() + 1); renderForDate(currentDate); });
            viewToggleButton.addEventListener('click', () => toggleView(currentView === 'monthly' ? 'daily' : 'monthly'));
            closeButton.addEventListener('click', closeModal);
            cancelButton.addEventListener('click', closeModal);
            infoBoxCloseButton.addEventListener('click', clearSelection);
            window.addEventListener('click', (event) => { if (event.target == modal) closeModal(); });
            document.body.addEventListener('click', (event) => { if (!event.target.closest('.booking-block, #info-box')) clearSelection(); });
            const infoBoxHeader = document.getElementById('info-box-header');
            infoBoxHeader.addEventListener('click', (e) => { if (!e.target.closest('#info-box-toggle-button')) document.getElementById('info-box-wrapper').classList.toggle('is-collapsed'); });
            document.getElementById('info-box-toggle-button').addEventListener('click', () => document.getElementById('info-box-wrapper').classList.toggle('is-collapsed'));
            backupButton.addEventListener('click', exportData);
            restoreButton.addEventListener('click', () => restoreFileInput.click());
            clearDataButton.addEventListener('click', clearAllData);
            restoreFileInput.addEventListener('change', (e) => { const file = e.target.files[0]; if (file) { const reader = new FileReader(); reader.onload = (event) => { importData(event.target.result); restoreFileInput.value = ''; }; reader.readAsText(file); } });
            
            // ★フォーム送信処理をFirestore用に変更
            bookingForm.addEventListener('submit', async (event) => {
                event.preventDefault();
                const startDate = startPicker.selectedDates[0];
                const endDate = endPicker.selectedDates[0];
                if (!startDate || !endDate) { alert("開始日時と終了日時を正しく選択してください。"); return; }
                if (endDate <= startDate) { alert("終了日時は開始日時より後に設定してください。"); return; }
                const targetLane = parseInt(document.getElementById('lane-select').value, 10);
                const laneOverlap = allBookings.some(b => b.id !== editingBookingId && b.lane == targetLane && startDate < b.endDate && endDate > b.startDate);
                if (laneOverlap) {
                    alert("作業レーンの予約が他の予約と重複しています。"); return;
                }
                const bookingData = {
                    id: editingBookingId, startDate: startDate, endDate: endDate, lane: targetLane,
                    userName: document.getElementById('user-name').value,
                    carNumber: document.getElementById('car-number').value,
                    bookingType: document.getElementById('booking-type').value,
                    staffName: document.getElementById('staff-select').value,
                    staffName2: document.getElementById('staff-select-2').value,
                    loaner: document.querySelector('input[name="loaner"]:checked').value,
                    pickup: document.querySelector('input[name="pickup"]:checked').value,
                    delivery: document.querySelector('input[name="delivery"]:checked').value
                };
                const success = await saveBooking(bookingData);
                if (success) {
                    const targetDate = new Date(bookingData.startDate);
                    currentDate = new Date(targetDate.getFullYear(), targetDate.getMonth(), targetDate.getDate());
                    updateDateDisplay(currentDate);
                    closeModal();
                }
            });

            // ★編集ボタンの処理（変更なし）
            editBookingButton.addEventListener('click', () => {
                const selectedBlock = document.querySelector('.booking-block.selected');
                if (!selectedBlock) return;
                const bookingToEdit = allBookings.find(b => b.id === selectedBlock.id);
                if (bookingToEdit) openModal(null, bookingToEdit);
            });

            // ★削除ボタンの処理をFirestore用に変更
            deleteBookingButton.addEventListener('click', () => {
                const selectedBlock = document.querySelector('.booking-block.selected');
                if (!selectedBlock) return;
                if (confirm("この予約を本当に削除しますか？")) {
                    deleteBooking(selectedBlock.id);
                }
            });

            currentDateDisplay.addEventListener('click', () => {
                flatpickr(currentDateDisplay, { locale: "ja", defaultDate: currentDate, onClose: (selectedDates) => { if (selectedDates[0]) renderForDate(selectedDates[0]); } }).open();
            });

            // =========================================================================
            // 6. アプリケーションの初期化 ★localStorageからFirestoreに変更
            // =========================================================================
            function timeTick() {
                updateCurrentTimeLine();
                requestAnimationFrame(timeTick);
            }

            buildSchedulerUI();
            setupRealtimeListener(); // ★リアルタイム監視を開始！
            
            document.getElementById('info-box-wrapper').classList.add('is-collapsed');
            toggleView(currentView);
            timeTick();
        });    
    </script>
</body>
</html>